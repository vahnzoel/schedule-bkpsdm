# Nixpacks configuration file for Laravel 12 + Livewire 4 Full Stack

[phases.setup]
commands = [
  # System packages
  "nix-env -iA nixpkgs.php phpPackages.composer phpPackages.sqlite phpPackages.redis phpPackages.phpredis",
  "nix-env -iA nixpkgs.libreoffice nixpkgs.poppler-utils",
  "nix-env -iA nixpkgs.nodejs nixpkgs.npm nginx supervisor",
]

[phases.build]
commands = [
  "composer install --no-interaction --prefer-dist --optimize-autoloader",
  "npm install",
  "npm run build",
  "mkdir -p storage bootstrap/cache database",
  "chmod -R 775 storage bootstrap/cache database",
]

[phases.start]
commands = [
  # Start Redis
  "redis-server --daemonize yes",
  
  # Start PHP-FPM
  "php-fpm -D",
  
  # Start Supervisor to run Laravel queue worker
  "supervisord -c /app/.nixpacks/supervisord.conf",
  
  # Start Cron for Laravel scheduled tasks
  "cron",
  
  # Start Nginx in foreground
  "nginx -g 'daemon off;'"
]

[env]
NIXPACKS_PHP_ROOT_DIR = "/app/public"
NIXPACKS_PHP_FALLBACK_PATH = "/index.php"
APP_ENV = "production"
APP_DEBUG = "false"
APP_KEY = "base64:YOUR_APP_KEY_HERE"
DB_CONNECTION = "sqlite"
DB_DATABASE = "/app/database/database.sqlite"
CACHE_DRIVER = "redis"
QUEUE_CONNECTION = "redis"
